<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Event Map</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 20px;
}

h2 {
  text-align: center;
}

#map {
  position: relative;
  max-width: 420px;
  margin: 20px auto;

  background: #fdfdfd;
  border: 4px solid #000;
  border-radius: 16px;
  padding: 20px;
  height: 420px;
}

.station {
  position: absolute;
  width: 140px;
  height: 80px;

  background: #ffffff;
  border: 3px dashed #333;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  user-select: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.station.active {
  background: #dff5ff;
}

.star {
  position: absolute;
  top: 6px;
  right: 8px;
  display: none;
}

/* Station positions (ROUGH, adjustable later) */
#OLED { top: 20px; left: 20px; }
#ULTRA { top: 20px; right: 20px; }
#QNED { bottom: 20px; left: 20px; }
#MRGB { bottom: 20px; right: 20px; }

/* Scanner modal */
#scannerModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
}

#reader {
  width: 100%;
  max-width: 420px;
  margin: 40px auto;
}

#closeBtn {
Â  display: block;
Â  margin: 10px auto;
Â  padding: 10px 20px;
}

.completed {
position: fixed; 
inset: 0;
background: rgba(0,0,0,0.85);
display: flex;
align-items: center;
justify-content: center;
z-index: 999;
}

.hidden {
display: none;
}

.pass-card {
position: relative;
max-width: 320px;
background: #fff;
border-radius: 16px;
padding: 24px 28px;
text-align: center;
width: 90%;
}

.pass-card h2 {
margin: 0 0 8px;
}

.timestamp {
margin: 12px 0;
color: #555;
font-size: 14px;
}

.note {
margin-top: 16px;
font-size: 14px;
}

.pulse {
position: absolute;
inset: -6px;
border-radius: 20px;
border: 2px solid #4CAF50;
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { opacity: 0.2; }
50% { opacity: 0.6; }
100% { opacity: 0.2; }
}

.redeem-btn {
margin-top: 18px;
padding: 12px;
width: 100%;
border: none;
border-radius: 10px;
background: #d32f2f;
color: #fff;
font-size: 15px;
font-weight: bold;
}

</style>
</head>

<body>

<h2>Event Stations</h2>
<p style="text-align:center">
Complete all stations to redeem a prize
</p>

<div id="map">
Â  <div class="station" id="OLED" onclick="openScanner()">
Â  Â  OLED
Â  Â  <span class="star" id="star-OLED">â­</span>
Â  </div>

Â  <div class="station" id="ULTRA" onclick="openScanner()">
Â  Â  ULTRA
Â  Â  <span class="star" id="star-ULTRA">â­</span>
Â  </div>

Â  <div class="station" id="QNED" onclick="openScanner()">
Â  Â  QNED
Â  Â  <span class="star" id="star-QNED">â­</span>
Â  </div>

Â  <div class="station" id="MRGB" onclick="openScanner()">
Â  Â  MRGB
Â  Â  <span class="star" id="star-MRGB">â­</span>
Â  </div>
</div>

<div id="completedPass" class="completed hidden">
Â  <div class="pass-card">
Â  Â  <h2>ğŸ‰ Pass Completed!</h2>
Â  Â  <p>All stations cleared</p>

Â  Â  <div class="timestamp" id="passTime"></div>

Â  Â  <p class="note">
Â  Â  Â  Show this screen to staff to redeem<br>
Â  Â  Â  <strong>1 claw machine token</strong><br>
      Good Luck!
Â  Â  </p>
    <button id="redeemBtn" class="redeem-btn">
Redeem!
</button>

Â  Â  <div class="pulse"></div>
Â  </div>
</div>

<div id="redeemedOverlay" class="completed hidden">
Â  <div class="pass-card">
Â  Â  <h2>âŒ Pass Used</h2>
Â  Â  <p>Token has been redeemed.</p>

Â  Â  <div class="timestamp" id="redeemedTime"></div>

Â  Â  <p class="note">
Â  Â  Â  
Â  Â  </p>
  
Â  Â  <div class="pulse"></div>
Â  </div>
</div>


<div id="scannerModal">
Â  <div id="reader"></div>
Â  <button id="closeBtn" onclick="closeScanner()">Cancel</button>
</div>


<script>
window.addEventListener("load", () => {
updateStars()
// if (allStationsCompleted()) showCompletedPass()
let p = loadProgress()
if (p.redeemed) {
showRedeemed()
} else if (allstationsCompleted()) {
showCompletedPass()
}
})


let scanner;

function loadProgress() {
Â  return JSON.parse(localStorage.getItem("eventProgress") || "{}");
}

function saveProgress(p) {
Â  localStorage.setItem("eventProgress", JSON.stringify(p));
}

function updateStars() {
Â  const p = loadProgress();
Â  Object.keys(p).forEach(id => {
Â  Â  const star = document.getElementById("star-" + id);
Â  Â  if (star) star.style.display = "inline";
Â  });
}

async function openScanner() {
Â  document.getElementById("scannerModal").style.display = "block";

Â  if (!scanner) {
Â  Â  scanner = new Html5Qrcode("reader");
Â  }

try {
await scanner.start(
Â  Â  { facingMode: "environment" },
Â  Â  { fps: 6, qrbox: 260, disableFlip: true },
Â  Â  onScan
Â  );
} catch(err) {
console.error("Camera start failed", err);
}
}

function closeScanner() {
Â  document.getElementById("scannerModal").style.display = "none";
Â  scanner?.stop().catch(() => {});
}

function onScan(text) {
Â  if (!text.startsWith("STATION:")) return;

Â  const stationId = text.split(":")[1];
Â  const p = loadProgress();
Â  p[stationId] = true;
Â  saveProgress(p);

Â  updateStars();
if (allStationsCompleted()) {
showCompletedPass() 
}
Â  closeScanner();
}

updateStars();

let STATIONS = ["OLED", "QNED", "ULTRA", "MRGB"]
function allStationsCompleted() {
let p = loadProgress();
return STATIONS.every(id => p[id] == true);
}

function showCompletedPass() {
let pass = document.getElementById("completedPass")
let timeEl = document.getElementById("passTime")

pass.classList.remove("hidden")

updateTime();
setInterval(updateTime, 1000)

function updateTime() {
let now = new Date()
timeEl.textContent = now.toLocaleString()
}}


document.getElementById("redeemBtn").addEventListener("click", () => {
let confirmRedeem = confirm("Confirm redemption?\nThe pass will become invalid.")
if (!confirmRedeem) return

// localStorage.removeItem("eventProgress")

let p = loadProgress()
p.redeemed = true
p.redeemedAt = new Date().toLocaleString()
saveProgress(p)

document.getElementById("completedPass").classList.add("hidden")
showRedeemed()
})

function showRedeemed() {
let pass = document.getElementById("redeemedOverlay")
let timeEl = document.getElementById("redeemedTime")

pass.classList.remove("hidden")
let p = loadProgress()
if (p.redeemedAt) {
timeEl.textContent = "Redeemed at: " + new Date(p.redeemedAt).toLocaleString() 
}}


</script>

</body>
</html>
